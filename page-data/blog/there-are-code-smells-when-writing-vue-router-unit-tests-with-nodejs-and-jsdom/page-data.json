{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/there-are-code-smells-when-writing-vue-router-unit-tests-with-nodejs-and-jsdom","result":{"data":{"markdownRemark":{"html":"<p>I have been trying to write unit tests in a web application to test the functionality of a vue-router definition. I quickly realized that these are not actually unit tests and they have code smell.</p>\n<p>I believe the definition of a unit test should include the follow statements:</p>\n<ul>\n<li>Unit tests need to run independently</li>\n<li>Unit tests should be able to be reordered in any combination</li>\n</ul>\n<p>I think it would be bad practice to not follow these definitions.</p>\n<h1>Create vue application to test the code smell</h1>\n<p>We will create a vue application with vue cli because it has everything out of the box to test this code smell.</p>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">$ npm install @vue/cli</code></pre></div>\n<blockquote>\n<p>I don't recommend using global installs, that is global pollution.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">$ npx vue create unit-test-project\n$ cd unit-test-project\n$ vue add @vue/unit-mocha\n$ npm run test:unit</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\"> WEBPACK  Compiling...\n\n  [===                      ] 10% (building)\n\n  [=========================] 98% (after emitting)\n\n DONE  Compiled successfully in 1949ms\n\n  [=========================] 100% (completed)\n\n WEBPACK  Compiled successfully in 1949ms\n\n MOCHA  Testing...\n\n  HelloWorld.vue\n    âˆš renders props.msg when passed\n\n  1 passing (23ms)\n\n MOCHA  Tests completed successfully</code></pre></div>\n<p>Great, everything is working. We have a foundation to write out unit tests.</p>\n<p>We need to install <a href=\"https://www.npmjs.com/package/vue-router\">vue-router</a> package now.</p>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">$ npm install vue-router</code></pre></div>\n<p>The unit tests are located in <code class=\"language-text\">tests/unit</code>. Here is the code for the unit test of the code smells.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> expect <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'chai'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> shallowMount<span class=\"token punctuation\">,</span> createLocalVue <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@vue/test-utils'</span>\n<span class=\"token keyword\">import</span> HelloWorld <span class=\"token keyword\">from</span> <span class=\"token string\">'@/components/HelloWorld.vue'</span>\n<span class=\"token keyword\">import</span> VueRouter <span class=\"token keyword\">from</span> <span class=\"token string\">\"vue-router\"</span>\n\n<span class=\"token keyword\">const</span> routes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'root'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token string\">'/home'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'home'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token string\">'/options'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'options'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token string\">'/profile'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'profile'</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Vue Router'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'initialize a vue router instance'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should default to root route name'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> localVue <span class=\"token operator\">=</span> <span class=\"token function\">createLocalVue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      localVue<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>VueRouter<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">VueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>routes<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> wrapper <span class=\"token operator\">=</span> <span class=\"token function\">shallowMount</span><span class=\"token punctuation\">(</span>HelloWorld<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> localVue<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> actual <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>name\n      <span class=\"token keyword\">const</span> expected <span class=\"token operator\">=</span> <span class=\"token string\">'root'</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>actual<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>expected<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'when navigating'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should be able to access home\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> localVue <span class=\"token operator\">=</span> <span class=\"token function\">createLocalVue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        localVue<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>VueRouter<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">VueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>routes<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> wrapper <span class=\"token operator\">=</span> <span class=\"token function\">shallowMount</span><span class=\"token punctuation\">(</span>HelloWorld<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> localVue<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">'home'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> actual <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>name\n        <span class=\"token keyword\">const</span> expected <span class=\"token operator\">=</span> <span class=\"token string\">'home'</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>actual<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>expected<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should be able to access options from root path\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> localVue <span class=\"token operator\">=</span> <span class=\"token function\">createLocalVue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        localVue<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>VueRouter<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">VueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>routes<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> wrapper <span class=\"token operator\">=</span> <span class=\"token function\">shallowMount</span><span class=\"token punctuation\">(</span>HelloWorld<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> localVue<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> currentRouteName <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>name\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>currentRouteName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span>\n        wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">'options'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> actual <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>name\n        <span class=\"token keyword\">const</span> expected <span class=\"token operator\">=</span> <span class=\"token string\">'options'</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>actual<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>expected<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<blockquote>\n<p>I delete the unit test file that is already there because we do not need it for this test.</p>\n</blockquote>\n<p>I created a routes array with the routes that I want to test inside a vue router. Say if we declare these routes in our web application and we want to make sure they are all accessible. We should be able to initialize our routes and be able to navigate to them within the vue router unit test. </p>\n<p>This is were the code starts to smell.</p>\n<p>We first write a unit test that we can access home. Great that unit test passes.</p>\n<p>Now let us write a <code class=\"language-text\">should be able to access options from root path</code>. Maybe we have had a bug lately that someone on the root path cannot route to options. </p>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">$ npm run test:unit \n  Vue Router\n    initialize a vue router instance\n      âˆš should default to root route name\n      when navigating\n        âˆš should be able to access home\n        1) should be able to access options from root path\n\n  2 passing (108ms)\n  1 failing\n\n  1) Vue Router\n       initialize a vue router instance\n         when navigating\n           should be able to access options from root path:\n\n      AssertionError: expected &#39;home&#39; to equal &#39;root&#39;\n      + expected - actual\n\n      -home\n      +root</code></pre></div>\n<p>Wait what? I have a unit test that passes saying that when the vue router initializes the current route is <code class=\"language-text\">/</code> and the name is <code class=\"language-text\">root</code>.</p>\n<p>This is why the code smells, we thought we were writing a unit test to test the functionality of the vue router. What we see is a unit test N+1 being effected by a unit test N. This goes against our definition of our unit test stated above.</p>\n<p>Try commenting out the unit test <code class=\"language-text\">should be able to access home</code> and rerun it. It will work.</p>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\"> DONE  Compiled successfully in 1723ms\n\n  [=========================] 100% (completed)\n\n WEBPACK  Compiled successfully in 1723ms\n\n MOCHA  Testing...\n\n  Vue Router\n    initialize a vue router instance\n      âˆš should default to root route name\n      when navigating\n        âˆš should be able to access options from root path\n\n  2 passing (36ms)\n\n MOCHA  Tests completed successfully</code></pre></div>\n<p>Okay, well what am I supposed to do? Why is this happening? I created my own localVue, I created my own VueRouter instance. Why is the vue router being edited across unit tests?</p>\n<p>I check the vue test util documentation </p>\n<blockquote>\n<p>createLocalVue returns a Vue class for you to add components, mixins and install plugins without polluting the global Vue class.</p>\n</blockquote>\n<p>Okay great, just what I want!</p>\n<p>No way it could be my <code class=\"language-text\">VueRouter</code> instance, it is a new object everytime! I'll prove it!</p>\n<p>I'll add a key to the objects to prove they are different and console log each object with that key</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">localVue<span class=\"token punctuation\">.</span>myVar <span class=\"token operator\">=</span> <span class=\"token string\">\"I'll prove it!\"</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'localVue'</span><span class=\"token punctuation\">,</span>localVue<span class=\"token punctuation\">.</span>myVar<span class=\"token punctuation\">)</span>\nlocalVue<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>VueRouter<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">VueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>routes<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nrouter<span class=\"token punctuation\">.</span>myVar <span class=\"token operator\">=</span> <span class=\"token number\">42</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Router'</span><span class=\"token punctuation\">,</span>router<span class=\"token punctuation\">.</span>myVar<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// I also console.log the router, and localVue in the next 2 unit tests</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">  Vue Router\n    initialize a vue router instance\nlocalVue I&#39;ll prove it!\nRouter 42\n      âˆš should default to root route name\n      when navigating\nlocalVue undefined\nRouter undefined\n        âˆš should be able to access home\nlocalVue undefined\nRouter undefined\n        1) should be able to access options from root path</code></pre></div>\n<p>Okay, what gives? <code class=\"language-text\">localVue</code> and <code class=\"language-text\">router</code> are always new instances. They aren't shared across the unit tests.</p>\n<p>Wait what is shared? <code class=\"language-text\">VueRouter</code>, but wait! I created my own <code class=\"language-text\">createLocalVue</code> and my own <code class=\"language-text\">router</code> instance how is it possible the <code class=\"language-text\">VueRouter</code> that I am using is shared across all of them. I literally write a line of code to initialize a new router object in the <code class=\"language-text\">shallowMount</code>! </p>\n<p>What happens if I add some variables to the <code class=\"language-text\">VueRouter</code> object that is imported at the top level.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> VueRouter <span class=\"token keyword\">from</span> <span class=\"token string\">\"vue-router\"</span>\n\nVueRouter<span class=\"token punctuation\">.</span>myVar <span class=\"token operator\">=</span> <span class=\"token string\">\"Why is this happening?\"</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">  Vue Router\n    initialize a vue router instance\nimport VueRouter Why is this happening?\nlocalVue I&#39;ll prove it!\nRouter 42\n      âˆš should default to root route name\n      when navigating\nimport VueRouter Why is this happening?\nlocalVue undefined\nRouter undefined\n        âˆš should be able to access home\nimport VueRouter Why is this happening?\nlocalVue undefined\nRouter undefined\n        1) should be able to access options from root path</code></pre></div>\n<p>Well duhh that should print, the scoping of <code class=\"language-text\">VueRouter</code> import is at the top level of the file. What did you expect? Okay but what about the <code class=\"language-text\">VueRouter</code> that is then <code class=\"language-text\">used</code> inside my localVue.</p>\n<p>We can take a look at the documentation for <code class=\"language-text\">Vue.use</code></p>\n<p><a href=\"https://vuejs.org/v2/api/#Vue-use\">https://vuejs.org/v2/api/#Vue-use</a></p>\n<blockquote>\n<p>When this method is called on the same plugin multiple times, the plugin will be installed only once.</p>\n</blockquote>\n<p>Well I have 3 different Vue instances, I proved it! </p>\n<p>More documentation :</p>\n<p><a href=\"https://vuejs.org/v2/guide/plugins.html\">https://vuejs.org/v2/guide/plugins.html</a></p>\n<blockquote>\n<p>Vue.use automatically prevents you from using the same plugin more than once, so calling it multiple times on the same plugin will install the plugin only once.</p>\n</blockquote>\n<p>Well how do I make the <code class=\"language-text\">VueRouters</code> not talk to each other?</p>\n<p>After doing some some research,</p>\n<p><a href=\"https://stackoverflow.com/questions/37459565/es6-import-duplicates\">https://stackoverflow.com/questions/37459565/es6-import-duplicates</a></p>\n<p><a href=\"https://tc39.es/ecma262/#sec-hostresolveimportedmodule\">https://tc39.es/ecma262/#sec-hostresolveimportedmodule</a></p>\n<blockquote>\n<p>Each time this operation is called with a specific referencingScriptOrModule, specifier pair as arguments it must return the same Module Record instance if it completes normally.</p>\n</blockquote>\n<p>Can we somehow create a new instance and use that instead of using one import statement above?</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// index.js inside the folder createLocalVueRouter</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createLocalVueRouter</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">delete</span> require<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">[</span>require<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue-router'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> \n  <span class=\"token keyword\">return</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue-router'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I know that you can delete the cache in node.js and re-require the module for it retrieves a new instance.</p>\n<p>Okay we should make some new unit tests now knowing we can have 3 seperate vue router import statements for the vue routers are dependent on each other.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> expect <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'chai'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> shallowMount<span class=\"token punctuation\">,</span> createLocalVue <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@vue/test-utils'</span>\n<span class=\"token keyword\">import</span> HelloWorld <span class=\"token keyword\">from</span> <span class=\"token string\">'@/components/HelloWorld.vue'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>createLocalVueRouter<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"../../createLocalVueRouter\"</span>\n\n<span class=\"token keyword\">const</span> routes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'root'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token string\">'/home'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'home'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token string\">'/options'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'options'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token string\">'/profile'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'profile'</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Vue Router'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'initialize a vue router instance'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should default to root route name'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> localVueRouter <span class=\"token operator\">=</span> <span class=\"token function\">createLocalVueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> localVue <span class=\"token operator\">=</span> <span class=\"token function\">createLocalVue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      localVue<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>localVueRouter<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">localVueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>routes<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> wrapper <span class=\"token operator\">=</span> <span class=\"token function\">shallowMount</span><span class=\"token punctuation\">(</span>HelloWorld<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> localVue<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> actual <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>name\n      <span class=\"token keyword\">const</span> expected <span class=\"token operator\">=</span> <span class=\"token string\">'root'</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>actual<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>expected<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'when navigating'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should be able to access home\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> localVueRouter <span class=\"token operator\">=</span> <span class=\"token function\">createLocalVueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> localVue <span class=\"token operator\">=</span> <span class=\"token function\">createLocalVue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        localVue<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>localVueRouter<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">localVueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>routes<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> wrapper <span class=\"token operator\">=</span> <span class=\"token function\">shallowMount</span><span class=\"token punctuation\">(</span>HelloWorld<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> localVue<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">'home'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> actual <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>name\n        <span class=\"token keyword\">const</span> expected <span class=\"token operator\">=</span> <span class=\"token string\">'home'</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>actual<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>expected<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should be able to access options from root path\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> localVueRouter <span class=\"token operator\">=</span> <span class=\"token function\">createLocalVueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> localVue <span class=\"token operator\">=</span> <span class=\"token function\">createLocalVue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        localVue<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>localVueRouter<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">localVueRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>routes<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> wrapper <span class=\"token operator\">=</span> <span class=\"token function\">shallowMount</span><span class=\"token punctuation\">(</span>HelloWorld<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> localVue<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> currentRouteName <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>name\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>currentRouteName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span>\n        wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">'options'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> actual <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span>vm<span class=\"token punctuation\">.</span>$router<span class=\"token punctuation\">.</span>currentRoute<span class=\"token punctuation\">.</span>name\n        <span class=\"token keyword\">const</span> expected <span class=\"token operator\">=</span> <span class=\"token string\">'options'</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>actual<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span>expected<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">$ npm run test:unit\n MOCHA  Testing...\n\n  Vue Router\n    initialize a vue router instance\n      âˆš should default to root route name\n      when navigating\n        âˆš should be able to access home\n        1) should be able to access options from root path\n\n  2 passing (107ms)\n  1 failing\n\n  1) Vue Router\n       initialize a vue router instance\n         when navigating\n           should be able to access options from root path:\n\n      AssertionError: expected &#39;home&#39; to equal &#39;root&#39;\n      + expected - actual\n\n      -home\n      +root</code></pre></div>\n<p>Why is this happening? </p>\n<p>vue-router actually uses global variables. You can't uncache and reload the component with module requires. Why would you think you can do that? The module still is accessing and using global variables. You can't reload the module.</p>\n<p>Look at the function <a href=\"https://github.com/vuejs/vue-router/blob/65de048ee9f0ebf899ae99c82b71ad397727e55d/src/history/hash.js#L109\">getHash</a></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">getHash</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// We can't use window.location.hash here because it's not</span>\n  <span class=\"token comment\">// consistent across browsers - Firefox will pre-decode it!</span>\n  <span class=\"token keyword\">var</span> href <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> index <span class=\"token operator\">=</span> href<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// empty path</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token string\">''</span> <span class=\"token punctuation\">}</span>\n\n  href <span class=\"token operator\">=</span> href<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>index <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// decode the hash but not the search or hash</span>\n  <span class=\"token comment\">// as search(query) is already decoded</span>\n  <span class=\"token comment\">// https://github.com/vuejs/vue-router/issues/2708</span>\n  <span class=\"token keyword\">var</span> searchIndex <span class=\"token operator\">=</span> href<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'?'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>searchIndex <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> hashIndex <span class=\"token operator\">=</span> href<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hashIndex <span class=\"token operator\">></span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      href <span class=\"token operator\">=</span> <span class=\"token function\">decodeURI</span><span class=\"token punctuation\">(</span>href<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> hashIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> href<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>hashIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> href <span class=\"token operator\">=</span> <span class=\"token function\">decodeURI</span><span class=\"token punctuation\">(</span>href<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    href <span class=\"token operator\">=</span> <span class=\"token function\">decodeURI</span><span class=\"token punctuation\">(</span>href<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> searchIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> href<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>searchIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> href\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> href <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Great, global variables.</p>\n<p>If you print the value of <code class=\"language-text\">href</code> each time in our unit test above this is what you will see</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  Vue Router\n    initialize a vue router instance\n<span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">localhost</span><span class=\"token regex-delimiter\">/</span></span>\n<span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">/</span>#<span class=\"token operator\">/</span>\n<span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">/</span>#<span class=\"token operator\">/</span>\n      âˆš should <span class=\"token keyword\">default</span> to root route name\n      when navigating\n<span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">/</span>#<span class=\"token operator\">/</span>\n<span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">/</span>#<span class=\"token operator\">/</span>\n<span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">/</span>#<span class=\"token operator\">/</span>\n<span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">/</span>#<span class=\"token operator\">/</span>home\n        âˆš should be able to access home\n<span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">/</span>#<span class=\"token operator\">/</span>home\n<span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">/</span>#<span class=\"token operator\">/</span>home\n<span class=\"token literal-property property\">http</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">/</span>#<span class=\"token operator\">/</span>home\n        <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> should be able to access options from root path</code></pre></div>\n<p>You can see that the <code class=\"language-text\">window.location.href</code> is being used across all the unit tests. <code class=\"language-text\">window.location.href</code> isn't even <code class=\"language-text\">vue-router</code> that is from JSDOM.</p>\n<p>We can update our <code class=\"language-text\">createLocalVueRouter</code> function to account for this global variable.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createLocalVueRouter</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">delete</span> require<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">[</span>require<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue-router'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> \n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window <span class=\"token operator\">&amp;&amp;</span> window<span class=\"token punctuation\">.</span>location <span class=\"token operator\">&amp;&amp;</span> window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> <span class=\"token string\">'/'</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue-router'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>All the tests pass now.</p>\n<div class=\"gatsby-highlight\" data-language=\"terminal\"><pre class=\"language-terminal\"><code class=\"language-terminal\">$ npm run test:unit\n MOCHA  Testing...\n\n  Vue Router\n    initialize a vue router instance\n      âˆš should default to root route name\n      when navigating\n        âˆš should be able to access home\n        âˆš should be able to access options from root path\n\n  3 passing (174ms)\n\n MOCHA  Tests completed successfully</code></pre></div>\n<p>This is just a mess. We have a module that relies on global variables and the state isn't being restored in normal usage. You cannot easily write a unit test because of this global variable. The global variable actually comes from JSDOM.</p>\n<p><a href=\"https://www.npmjs.com/package/@vue/cli-plugin-unit-mocha\">https://www.npmjs.com/package/@vue/cli-plugin-unit-mocha</a></p>\n<blockquote>\n<p>Note the tests are run inside Node.js with browser environment simulated with JSDOM.</p>\n</blockquote>\n<p>Now I thought to myself how is vue-router writing it's unit tests for vue-router if I ran into this issue? I checked out their repo myself and looked into the unit tests.</p>\n<p><a href=\"https://github.com/vuejs/vue-route\">https://github.com/vuejs/vue-route</a></p>\n<p><a href=\"https://github.com/vuejs/vue-router/blob/65de048ee9f0ebf899ae99c82b71ad397727e55d/test/unit/specs/discrete-components.spec.js\">https://github.com/vuejs/vue-router/blob/65de048ee9f0ebf899ae99c82b71ad397727e55d/test/unit/specs/discrete-components.spec.js</a></p>\n<p>I installed the repo and found this file <code class=\"language-text\">discrete-components.spec.js</code>. You will see that they are testing a similar unit test to what I want to test and it passes. Why does theirs work but not mine?</p>\n<p>Oh what they don't tell you is they are actually unit testing their code without global variables.</p>\n<p><a href=\"https://router.vuejs.org/guide/essentials/history-mode.html#example-server-configurations\">https://router.vuejs.org/guide/essentials/history-mode.html#example-server-configurations</a></p>\n<blockquote>\n<p>The default mode for vue-router is hash mode - it uses the URL hash to simulate a full URL so that the page won't be reloaded when the URL changes.</p>\n</blockquote>\n<p><a href=\"https://github.com/vuejs/vue-router/blob/65de048ee9f0ebf899ae99c82b71ad397727e55d/src/index.js#L44\">https://github.com/vuejs/vue-router/blob/65de048ee9f0ebf899ae99c82b71ad397727e55d/src/index.js#L44</a></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token keyword\">let</span> mode <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>mode <span class=\"token operator\">||</span> <span class=\"token string\">'hash'</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>fallback <span class=\"token operator\">=</span> mode <span class=\"token operator\">===</span> <span class=\"token string\">'history'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>supportsPushState <span class=\"token operator\">&amp;&amp;</span> options<span class=\"token punctuation\">.</span>fallback <span class=\"token operator\">!==</span> <span class=\"token boolean\">false</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>fallback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      mode <span class=\"token operator\">=</span> <span class=\"token string\">'hash'</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>inBrowser<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      mode <span class=\"token operator\">=</span> <span class=\"token string\">'abstract'</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mode <span class=\"token operator\">=</span> mode</code></pre></div>\n<p>No you aren't! You are using 'abstract'.  You aren't using hash mode in your unit tests.\nWell if you look at the code if you aren't in a browser it will default to abstract. The documentation they provide is misleading.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> inBrowser <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> window <span class=\"token operator\">!==</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>JSDOM creates a global window object in the mocha unit tests. That means it will be in <code class=\"language-text\">hash</code> mode in our unit tests.</p>\n<p>They are using the <code class=\"language-text\">abstract</code> mode which is used Node.js environments. </p>\n<p>If I initialize all my VueRouter instances to use <code class=\"language-text\">mode: abstract</code> my unit tests would pass but that is not the point!</p>\n<p>The <code class=\"language-text\">vue-router</code> module says the browser is determined by the window object. JSDOM reimplements the DOM by creating a window object all while you are in Node.js.</p>\n<p>You are telling me that we are using Node.js but then using a browser environment so VueRouter goes to hash mode. So now the unit tests are dependant on one another because the entire environment is in browser mode. It won't default to abstract mode.</p>\n<p>This can be confusing, you are in Node.js but you are in a simulated browser at the same time. How can you effecetively write unit tests that don't effect one another? I wrote unit tests that import and create local variables that shouldn't be scoped into a function but it actually is because we are sharing a global variable that is <code class=\"language-text\">window.location.href</code>. This is utterly annoying. I could have easily written <code class=\"language-text\">abstract</code> within the initialization statement. I could have easily written <code class=\"language-text\">window.location.href = ''</code> after each <code class=\"language-text\">it</code> function to clear the history. I could have easily imported variables that are not scoped into another function to write my unit test but I can't. This library effects global storage and it doesn't really tell you.</p>\n<p>I say easily after spending a long time debugging why this problem occurs and what are potential solutions.</p>\n<p>You cannot simulate a new <code class=\"language-text\">window.location.href</code> with a new <code class=\"language-text\">VueRouter</code> object across the browser environment in each unit test with how they have implemented their library. It is really annoying. </p>\n<p>I don't want one VueRouter to effect another VueRouter clearly that is asking for too much.</p>\n<p>My current solution to this problem.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createLocalVueRouter</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">delete</span> require<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">[</span>require<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue-router'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> \n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window <span class=\"token operator\">&amp;&amp;</span> window<span class=\"token punctuation\">.</span>location <span class=\"token operator\">&amp;&amp;</span> window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> <span class=\"token string\">'/'</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vue-router'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1>JSDOM extra information</h1>\n<p>What really is happening is that within each unit test the JSDOM does not get cleared. VueRouter doesn't care or know about that it is just using whatever is in <code class=\"language-text\">window.location</code>. What do either test runners or others have to say about clearing JSDOM between unit tests?</p>\n<h2>JSDOM does not clear after every unit test</h2>\n<p><a href=\"https://stackoverflow.com/questions/42805128/does-jest-reset-the-jsdom-document-after-every-suite-or-test\">https://stackoverflow.com/questions/42805128/does-jest-reset-the-jsdom-document-after-every-suite-or-test</a></p>\n<blockquote>\n<p>No. Jest does not clean the JSDOM document after each test run! It only clears the DOM after all tests inside an entire file are completed.</p>\n</blockquote>\n<p>We are using mocha but the same idea applies.</p>\n<h2>Someone had the same idea as me but gets shut down</h2>\n<p><a href=\"https://github.com/facebook/jest/issues/1224\">https://github.com/facebook/jest/issues/1224</a></p>\n<blockquote>\n<p>I suggest if you need this, to either:</p>\n<ul>\n<li>Write your own cleanup handler.</li>\n<li>Create a separate test file.</li>\n</ul>\n<p>Does this work for you? At this point I'm quite hesitant to adding new APIs to support jsdom better.</p>\n</blockquote>\n<h1>NPM package</h1>\n<p>I created an NPM package for this solution as well.</p>\n<p>It can be found <a href=\"https://www.npmjs.com/package/createlocalvuerouter\">here</a></p>","frontmatter":{"date":"April 25, 2020","path":"/blog/there-are-code-smells-when-writing-vue-router-unit-tests-with-nodejs-and-jsdom","title":"There are code smells when writing vue router unit tests with Node.js and jsdom","categories":["Code"],"tags":["javascript","unit test","npm package","vue-router"]}}},"pageContext":{}},"staticQueryHashes":["3000541721"]}