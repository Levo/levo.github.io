<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.c0612b96af46bc825ea9.css">code[class*=language-],pre[class*=language-]{color:#9efeff;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;font-family:Operator Mono,Fira Code,Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-weight:400;font-size:17px;line-height:25px;letter-spacing:.5px;text-shadow:0 1px #222245}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{color:inherit;background:#a599e9}pre[class*=language-]{padding:2em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#1e1e3f}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token{font-weight:400}.token.cdata,.token.comment,.token.prolog{color:#b362ff}.token.atrule,.token.delimiter,.token.important,.token.keyword,.token.selector{color:#ff9d00}.token.attr-name,.token.operator{color:#ffb454}.token.punctuation{color:#fff}.token.boolean{color:#ff628c}.token.builtin,.token.doctype,.token.tag,.token.tag .punctuation{color:#ff9d00}.token.entity,.token.symbol{color:#6897bb}.token.constant,.token.number,.token.property,.token.variable{color:#ff628c}.token.char,.token.string{color:#a5ff90}.token.attr-value,.token.attr-value .punctuation{color:#a5c261}.token.attr-value .punctuation:first-child{color:#a9b7c6}.token.url{color:#287bde;text-decoration:underline}.token.function{color:#fad000}.token.regex{background:#364135}.token.bold{font-weight:700}.token.italic{font-style:italic}.token.inserted{background:#0f0}.token.deleted{background:#ff000d}code.language-css .token.property,code.language-css .token.property+.token.punctuation{color:#a9b7c6}code.language-css .token.id,code.language-css .token.selector>.token.attribute,code.language-css .token.selector>.token.class,code.language-css .token.selector>.token.pseudo-class,code.language-css .token.selector>.token.pseudo-element{color:#ffc66d}.token.class-name{color:#fb94ff}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:none}pre .line-highlight,pre .line-highlight.line-highlight,pre>code.line-highlight{margin-top:36px;background:linear-gradient(90deg,rgba(179,98,255,.17),transparent)}pre .line-highlight:before,pre .line-highlight[data-end]:after,pre>code.line-highlight:before,pre>code.line-highlight[data-end]:after{content:""}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{color:#000;background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0;color:#2d3436;color:#d73a49}div>a:not(:last-child){padding-right:16px}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:#000;font-family:georgia,serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt";background:#f0f0f0}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{background-color:#f0ecd0;color:rgba(0,0,0,.8);border-radius:6px;font-weight:500;margin:1.5rem 0;padding:1.5rem;line-height:1.6;font-size:1rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}.tags>.tag{margin-right:4px;margin-bottom:4px}.postlinks>.postlink{margin-bottom:12px}.postlinks>a{text-decoration:none}.introduction-github-buttons>span:nth-child(n+2){margin-left:4px}pre.language-terminal{position:relative;border:1px solid #d8d9da;border-radius:6px;padding:45px 1rem 1rem;margin:2rem 0;font-size:13px;background:#fff;color:#333}pre.language-terminal:before{content:"\2022   \2022   \2022";position:absolute;top:0;left:0;height:25px;background:linear-gradient(180deg,#f3f4f4 2%,#ebebeb 4%,#e4e4e4 98%,#bebebe 0);color:#ababab;width:100%;font-size:1.5rem;margin:0;line-height:0;padding:14px 0;text-indent:4px;letter-spacing:-10px}code[class*=language-terminal],pre[class*=language-terminal],pre code{color:#333;text-shadow:none}pre[class*=language-]{margin:2rem 0;box-shadow:3px 5px 20px rgba(0,0,0,.16)}</style><meta name="generator" content="Gatsby 2.20.8"/><title data-react-helmet="true">Articles | Kevin Nadro</title><meta data-react-helmet="true" name="description" content="Kevin Nadro is a full stack developer with a focus on Node.js, modern javascript, and web application development."/><meta data-react-helmet="true" property="og:title" content="Articles"/><meta data-react-helmet="true" property="og:description" content="Kevin Nadro is a full stack developer with a focus on Node.js, modern javascript, and web application development."/><meta data-react-helmet="true" property="og:type" content="website"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link as="script" rel="preload" href="/webpack-runtime-046dd4d24aaf37caabcd.js"/><link as="script" rel="preload" href="/framework-727eca7a674e10b21a9f.js"/><link as="script" rel="preload" href="/app-925e4a153e986e591ac3.js"/><link as="script" rel="preload" href="/styles-85a04149be4e142495ba.js"/><link as="script" rel="preload" href="/commons-6332a23abc97a0d9ba20.js"/><link as="script" rel="preload" href="/68cad14e2e15242fdacbacffb3e38cd4b0ed50b5-3da2dcc4e2bb914b6b9b.js"/><link as="script" rel="preload" href="/component---src-templates-blog-template-js-4f5355e6180bc713fdcb.js"/><link as="fetch" rel="preload" href="/page-data\blog\parsing-pdfs-in-javascript\page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data\app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><header style="margin-bottom:1.45rem"><div style="margin:0 auto;max-width:960px;padding:1.45rem 1.0875rem;display:flex;flex-direction:row;align-items:center;justify-content:space-between"><div><a style="text-decoration:none" href="/">Kevin Nadro</a></div><div style="display:flex;align-items:center;flex-direction:row"><a style="text-decoration:none" href="/about-me/">About me</a><a style="text-decoration:none" href="/articles/">Articles</a><a style="text-decoration:none" href="/contact/">Contact</a></div></div></header><div style="margin:0 auto;max-width:960px;padding:0px 1.0875rem 1.45rem;padding-top:0"><main><div class="blog-post-container"><div class="blog-post"><h1>Parsing PDFs in Javascript with PDF.js</h1><div class="tags" style="display:flex;flex-direction:row;align-items:center;justify-content:flex-start;flex-wrap:wrap"><div class="tag" style="padding:2.5px 5px;background:#dfdfdf;font-size:12px;border-radius:5px;text-transform:uppercase;color:black;white-space:nowrap">pdf.js</div><div class="tag" style="padding:2.5px 5px;background:#dfdfdf;font-size:12px;border-radius:5px;text-transform:uppercase;color:black;white-space:nowrap">javascript</div><div class="tag" style="padding:2.5px 5px;background:#dfdfdf;font-size:12px;border-radius:5px;text-transform:uppercase;color:black;white-space:nowrap">file processing</div><div class="tag" style="padding:2.5px 5px;background:#dfdfdf;font-size:12px;border-radius:5px;text-transform:uppercase;color:black;white-space:nowrap">memory leak</div><div class="tag" style="padding:2.5px 5px;background:#dfdfdf;font-size:12px;border-radius:5px;text-transform:uppercase;color:black;white-space:nowrap">async/await</div></div><p></p><h2>January 12, 2020</h2><div class="blog-post-content"><p>I needed to split a pdf into its pages, show previews and upload them to a storage. Here is a guide on how to do this step by step. I also provide all my source code in one HTML file at the end if you want to skip to that.</p>
<h2>Reading a PDF</h2>
<p>Say you have a file from an input file field, convert it to an array buffer for it can be read in with <a href="https://mozilla.github.io/pdf.js/">pdf.js</a>. After you read the file you will have a pdf document provide by the library. </p>
<ul>
<li>Read the file into memory</li>
</ul>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file-upload<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> fileInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"file-upload"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fileInput<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// File data</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> fileInput<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<ul>
<li>Convert File into array buffer</li>
</ul>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">readFileToArrayBuffer</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">fileData</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>fileData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> reader<span class="token punctuation">.</span>result
      <span class="token comment">// Convert to array buffer</span>
      <span class="token keyword">const</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li>Read array buffer to pdf document</li>
</ul>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">fileInput<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> fileInput<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> bytes <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFileToArrayBuffer</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// We have a PDf document now</span>
  <span class="token keyword">const</span> pdfDocument <span class="token operator">=</span> <span class="token keyword">await</span> pdfjsLib<span class="token punctuation">.</span><span class="token function">getDocument</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2>Splitting into pages</h2>
<p>The PDF document class has an API to get a page by a specific page number. We first should figure out the total page count then devise a for loop to get each page. </p>
<ul>
<li>Total page numbers in the PDF</li>
</ul>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> pdfDocument <span class="token operator">=</span> <span class="token keyword">await</span> pdfjsLib<span class="token punctuation">.</span><span class="token function">getDocument</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
<span class="token keyword">const</span> numPages <span class="token operator">=</span> pdfDocument<span class="token punctuation">.</span>numPages<span class="token punctuation">;</span></code></pre></div>
<ul>
<li>Read each page of the PDF by page number</li>
</ul>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Fetching pages starts at 1</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> pageNumber <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> pageNumber <span class="token operator">&lt;=</span> numPages<span class="token punctuation">;</span> pageNumber<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> pdfDocument<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>pageNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>Generating images from a pdf page</h2>
<p>In the client side we want to be able to show previews of each page at different resolutions. We can do this by rendering the page into a canvas element and saving it into a blob or data url. </p>
<p>A pdf uses vector method to render the content, when we want to save an image we will have to rasterize the pdf at a specifc resolution. </p>
<p>Types of images we will generate.</p>
<ul>
<li>64x64 icon</li>
<li>256x256 thumbnail</li>
<li>8k high resolution</li>
</ul>
<p>We will be preserving aspect ratio so it won't exactly be a square, just at most the value in one dimension. </p>
<ul>
<li>Get a page</li>
</ul>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Fetching pages starts at 1</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> pageNumber <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> pageNumber <span class="token operator">&lt;=</span> numPages<span class="token punctuation">;</span> pageNumber<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> pdfDocument<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>pageNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li>Compute the aspect ratio of the image with the desired resolution to scale the canvas and PDF</li>
</ul>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> viewport <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getViewport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>scale<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> scale <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>desiredResolution<span class="token operator">/</span> viewport<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
  desiredResolution <span class="token operator">/</span> viewport<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Prepare canvas using PDF page dimensions</span>
<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> viewport<span class="token punctuation">.</span>height <span class="token operator">*</span> scale<span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> viewport<span class="token punctuation">.</span>width <span class="token operator">*</span> scale<span class="token punctuation">;</span>

<span class="token comment">// Render PDF page into canvas context</span>
<span class="token keyword">const</span> scaledViewport <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getViewport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>scale<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> renderContext <span class="token operator">=</span> <span class="token punctuation">{</span>
  canvasContext<span class="token operator">:</span> context<span class="token punctuation">,</span>
  viewport<span class="token operator">:</span> scaledViewport
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<ul>
<li>A function to take a page and render it to a canvas with a desired resolution</li>
</ul>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">pageToCanvas</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">page<span class="token punctuation">,</span> desiredResolution</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> viewport <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getViewport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>scale<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> scale <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>desiredResolution<span class="token operator">/</span> viewport<span class="token punctuation">.</span>width<span class="token punctuation">,</span> desiredResolution <span class="token operator">/</span> viewport<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Prepare canvas using PDF page dimensions</span>
  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> viewport<span class="token punctuation">.</span>height <span class="token operator">*</span> scale<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> viewport<span class="token punctuation">.</span>width <span class="token operator">*</span> scale<span class="token punctuation">;</span>

  <span class="token comment">// Render PDF page into canvas context</span>
  <span class="token keyword">const</span> scaledViewport <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getViewport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>scale<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> renderContext <span class="token operator">=</span> <span class="token punctuation">{</span>
    canvasContext<span class="token operator">:</span> context<span class="token punctuation">,</span>
    viewport<span class="token operator">:</span> scaledViewport
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
  <span class="token keyword">return</span> canvas<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<ul>
<li>Use the helper function above to give you a data url or blob of the canvas</li>
</ul>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">generateImageToDataURL</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">page<span class="token punctuation">,</span> desiredResolution</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">pageToCanvas</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> desiredResolution<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">generateImageToBlob</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">page<span class="token punctuation">,</span> desiredResolution</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">pageToCanvas</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> desiredResolution<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> canvas<span class="token punctuation">.</span><span class="token function">generateImageToBlob</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Since we have a canvas we can either get the data in blob format for file uploading or dataurl for rendering the image in an img element for the user can see a preview.</p>
<h2>Pdf page preview</h2>
<p>Now that we have images locally we can render them in a table view for they can see the page of the pdf.</p>
<ul>
<li>I wrote some very basic HTML and DOM code to put the previews into the DOM. This shouldn't be used in production. This is just for testing the code for you can see the images.</li>
</ul>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icons<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>thumbnails<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8k<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> pageNumber <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> pageNumber <span class="token operator">&lt;=</span> numPages<span class="token punctuation">;</span> pageNumber<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> pdfDocument<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>pageNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> icon <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToDataURL</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">putIconIntoDOM</span><span class="token punctuation">(</span>icon<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> thumbnail <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToDataURL</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">putThumbnailIntoDOM</span><span class="token punctuation">(</span>thumbnail<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> eightK <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToDataURL</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">put8kIntoDOM</span><span class="token punctuation">(</span>eightK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Helper functions to put elements into the DOM</span>
<span class="token comment">/**
 * put the icon data URL into an img element then into the DOM
 * @param {String} dataURL - src of the icon to put into img element
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">putIconIntoDOM</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dataURL</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  img<span class="token punctuation">.</span>src <span class="token operator">=</span> dataURL<span class="token punctuation">;</span>
  <span class="token keyword">const</span> icons <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"icons"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  icons<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * put the thumbnail data URL into an img element then into the DOM
 * @param {String} dataURL - src of the thumbnail to put into img element
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">putThumbnailIntoDOM</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dataURL</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  img<span class="token punctuation">.</span>src <span class="token operator">=</span> dataURL<span class="token punctuation">;</span>
  <span class="token keyword">const</span> thumbnails <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"thumbnails"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  thumbnails<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * put the 8k data URL into an img element then into the DOM
 * @param {String} dataURL - src of the 8k to put into img element
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">put8kIntoDOM</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dataURL</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  img<span class="token punctuation">.</span>src <span class="token operator">=</span> dataURL<span class="token punctuation">;</span>
  <span class="token keyword">const</span> eightK <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"8k"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  eightK<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<h2>File uploading</h2>
<p>It is possible to now upload each one of these as a Blob to a storage.</p>
<p>Use your api, web server, microservice, or favorite frontend upload library to directly upload the blob to google cloud, aws s3 or azure.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Fetching pages starts at 1</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> pageNumber <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> pageNumber <span class="token operator">&lt;=</span> numPages<span class="token punctuation">;</span> pageNumber<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> pdfDocument<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>pageNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> blobIcon <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToBlob</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> blobThumbnail <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToBlob</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> blob8k <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToBlob</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>Common Gotchas</h2>
<ul>
<li>Memory leaks</li>
</ul>
<p>If you do not call the destroy and cleanup methods your garbage collector will fail to delete the respective memory allocated by the webworker that pdf.js uses. Tests this out by trying to parse a 60+ page pdf, your javascript memory will reach well over one 1GB and will not go down. I had to learn this the hard way.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Cleans up resources allocated by the page.</span>
page<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">/**
 * Cleans up resources allocated by the document, e.g. created `@font-face`.
 */</span>
 pdfDocument<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Destroys the current document instance and terminates the worker.
 */</span>
 pdfDocument<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<ul>
<li>source code documentation</li>
</ul>
<p>If you go to the documentation for the library on their website it says it is incomplete. They tell you to use the source code api.js file for documentation instead. The code is well documented but searching is difficult because you dont know any function name and have to guess by searching keywords. It was helpful enough for me to find the destroy and cleanup methods by guessing the names. </p>
<p><a href="https://mozilla.github.io/pdf.js/api/">documentation</a></p>
<ul>
<li>Speed</li>
</ul>
<p>Reading the pdf, parsing the pages and generating images can be quite slow since javascript is single threaded. I haven't figured out any optimizations. If you have any shoot me an email, ill update this post with your findings. </p>
<ul>
<li>You dont get the binary data of each page in a pdf, you only get the whole pdf</li>
</ul>
<p>Say if you wanted to split the pdf into pages of single pdfs i dont think this is possible. That is why we are using the canvas and images. The pdf.js library seems to only provide the entire pdf binary but you cant extract the page binaries to create a pdf file blob. There maybe a way to read the original binary and split the binary at each page and create a pdf header with the page binary to wrap the page to make it a pdf. I think this is quite difficult and maybe not worth it. </p>
<ul>
<li>Pdf pages dont have filenames, you cant seem to get them either?</li>
</ul>
<p>Pdf pages dont have filenames which makes sense but could be annoying because each page has a specific context and would want a filename. For now we have to use the original filename with the page number to name it something useful.</p>
<ul>
<li>Outlines attribute doesnt exist in this library, you only get thumbnails.</li>
</ul>
<p>Pdf.js may not parse all the attributes of a pdf. I dont know how or if pdf.js had these attributes. This can be useful because these outlines maybe able to name the pdf pages or give us more informatiom on how to parse and render the pdf. </p>
<h1>All the source code in one HTML file.</h1>
<p>Save it as <code class="language-text">index.html</code> and run it locally in google chrome. </p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">></span>
<span class="token operator">&lt;</span>html<span class="token operator">></span>
  <span class="token operator">&lt;</span>head<span class="token operator">></span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.3.200/pdf.min.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">></span>
  <span class="token operator">&lt;</span>body<span class="token operator">></span>
    
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      Choose a file
      <span class="token operator">&lt;</span>input id<span class="token operator">=</span><span class="token string">"file-upload"</span> type<span class="token operator">=</span><span class="token string">"file"</span><span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>

    <span class="token operator">&lt;</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"icons"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"thumbnails"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"8k"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&lt;</span>script<span class="token operator">></span>

      <span class="token comment">/**
       * Converts a File object into an Uint8Array buffer
       * @param {File} fileData - file object read from the input field
       * @returns {Promise} - resolves with an arraybuffer of the file
       */</span>
      <span class="token keyword">const</span> <span class="token function-variable function">readFileToArrayBuffer</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">fileData</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>fileData<span class="token punctuation">)</span><span class="token punctuation">;</span>
          reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> reader<span class="token punctuation">.</span>result
            <span class="token keyword">const</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token keyword">const</span> <span class="token function-variable function">pageToCanvas</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">page<span class="token punctuation">,</span> desiredResolution</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> viewport <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getViewport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>scale<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> scale <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>desiredResolution<span class="token operator">/</span> viewport<span class="token punctuation">.</span>width<span class="token punctuation">,</span> desiredResolution <span class="token operator">/</span> viewport<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Prepare canvas using PDF page dimensions</span>
        <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> viewport<span class="token punctuation">.</span>height <span class="token operator">*</span> scale<span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> viewport<span class="token punctuation">.</span>width <span class="token operator">*</span> scale<span class="token punctuation">;</span>

        <span class="token comment">// Render PDF page into canvas context</span>
        <span class="token keyword">const</span> scaledViewport <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getViewport</span><span class="token punctuation">(</span><span class="token punctuation">{</span>scale<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> renderContext <span class="token operator">=</span> <span class="token punctuation">{</span>
          canvasContext<span class="token operator">:</span> context<span class="token punctuation">,</span>
          viewport<span class="token operator">:</span> scaledViewport
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
        <span class="token keyword">return</span> canvas<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> <span class="token function-variable function">generateImageToDataURL</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">page<span class="token punctuation">,</span> desiredResolution</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">pageToCanvas</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> desiredResolution<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> <span class="token function-variable function">generateImageToBlob</span> <span class="token operator">=</span> <span class="token keyword">async</span>  <span class="token punctuation">(</span><span class="token parameter">page<span class="token punctuation">,</span> desiredResolution</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">pageToCanvas</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> desiredResolution<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> canvas<span class="token punctuation">.</span><span class="token function">toBlob</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> fileInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"file-upload"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      fileInput<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> file <span class="token operator">=</span> fileInput<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> bytes <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFileToArrayBuffer</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> pdfDocument <span class="token operator">=</span> <span class="token keyword">await</span> pdfjsLib<span class="token punctuation">.</span><span class="token function">getDocument</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">.</span>promise<span class="token punctuation">;</span>
        <span class="token keyword">const</span> numPages <span class="token operator">=</span> pdfDocument<span class="token punctuation">.</span>numPages<span class="token punctuation">;</span>

        <span class="token comment">// Fetching pages starts at 1</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> pageNumber <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> pageNumber <span class="token operator">&lt;=</span> numPages<span class="token punctuation">;</span> pageNumber<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> pdfDocument<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>pageNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> icon <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToDataURL</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">putIconIntoDOM</span><span class="token punctuation">(</span>icon<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> thumbnail <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToDataURL</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">putThumbnailIntoDOM</span><span class="token punctuation">(</span>thumbnail<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> eightK <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToDataURL</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">put8kIntoDOM</span><span class="token punctuation">(</span>eightK<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> blobIcon <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToBlob</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> blobThumbnail <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToBlob</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> blob8k <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateImageToBlob</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// Cleans up resources allocated by the page.</span>
          page<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
        * Cleans up resources allocated by the document, e.g. created `@font-face`.
        */</span>
        pdfDocument<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
        * Destroys the current document instance and terminates the worker.
        */</span>
        pdfDocument<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


      <span class="token comment">// Helper functions to put elements into the DOM</span>
      <span class="token comment">/**
       * put the icon data URL into an img element then into the DOM
       * @param {String} dataURL - src of the icon to put into img element
       */</span>
      <span class="token keyword">const</span> <span class="token function-variable function">putIconIntoDOM</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dataURL</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>src <span class="token operator">=</span> dataURL<span class="token punctuation">;</span>
        <span class="token keyword">const</span> icons <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"icons"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        icons<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">/**
       * put the thumbnail data URL into an img element then into the DOM
       * @param {String} dataURL - src of the thumbnail to put into img element
       */</span>
      <span class="token keyword">const</span> <span class="token function-variable function">putThumbnailIntoDOM</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dataURL</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>src <span class="token operator">=</span> dataURL<span class="token punctuation">;</span>
        <span class="token keyword">const</span> thumbnails <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"thumbnails"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thumbnails<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">/**
       * put the 8k data URL into an img element then into the DOM
       * @param {String} dataURL - src of the 8k to put into img element
       */</span>
      <span class="token keyword">const</span> <span class="token function-variable function">put8kIntoDOM</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dataURL</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>src <span class="token operator">=</span> dataURL<span class="token punctuation">;</span>
        <span class="token keyword">const</span> eightK <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"8k"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eightK<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">></span></code></pre></div></div></div></div></main><footer></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-155164710-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/parsing-pdfs-in-javascript";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-925e4a153e986e591ac3.js"],"component---src-templates-blog-template-js":["/component---src-templates-blog-template-js-4f5355e6180bc713fdcb.js"],"component---src-pages-404-js":["/component---src-pages-404-js-7ef6b6be6d5225d8a32b.js"],"component---src-pages-about-me-js":["/component---src-pages-about-me-js-be7624aa5d7f0d9e6caf.js"],"component---src-pages-articles-js":["/component---src-pages-articles-js-271cbf6b7177727cc64d.js"],"component---src-pages-contact-js":["/component---src-pages-contact-js-5fd0479b01cf47a1a135.js"],"component---src-pages-index-js":["/component---src-pages-index-js-f0b18942c174e76cfe4f.js"]};/*]]>*/</script><script src="/component---src-templates-blog-template-js-4f5355e6180bc713fdcb.js" async=""></script><script src="/68cad14e2e15242fdacbacffb3e38cd4b0ed50b5-3da2dcc4e2bb914b6b9b.js" async=""></script><script src="/commons-6332a23abc97a0d9ba20.js" async=""></script><script src="/styles-85a04149be4e142495ba.js" async=""></script><script src="/app-925e4a153e986e591ac3.js" async=""></script><script src="/framework-727eca7a674e10b21a9f.js" async=""></script><script src="/webpack-runtime-046dd4d24aaf37caabcd.js" async=""></script></body></html>